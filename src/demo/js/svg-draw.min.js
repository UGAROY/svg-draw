var VectorEditor;!function(t){var e=function(){function e(t){this.editor=t,this.paper=t.paper,this.offset=5}return e.prototype.registerDragShapeEvent=function(){var t=this;this.shape.drag(function(e,r){"select"===t.editor.mode&&(t.shape.transform(t.currentTransformation),t.shape.transform(Raphael.format("...T{0}, {1}",e,r)),t.syncTracker())},function(){"select"===t.editor.mode&&(t.editor.unSelectAll(),t.showTracker(),t.editor.currentShape=t,t.currentTransformation=t.shape.transform())},function(){})},e.prototype.addTracker=function(){var e=this,r=this.shape.getBBox(!0);this.trackerSet=this.paper.set(),this.trackerSet.push(this.paper.rect(r.x-this.offset,r.y-this.offset,r.width+2*this.offset,r.height+2*this.offset),this.paper.circle((r.x+r.x2)/2,r.y-3*this.offset,5)),this.syncTracker(),this.trackerSet[1].attr("fill","#FFFFFF"),this.trackerSet.attr("stroke-dasharray","-"),this.trackerSet[1].mouseover(function(){this.attr("fill","red")}),this.trackerSet[1].mouseout(function(){this.attr("fill","white")}),this.trackerSet[1].drag(function(r,i,a,o,s){var h=t.getRelativePositionToWindow(e.editor.container),a=s.clientX-h[0],o=s.clientY-h[1],n=Math.atan2(o-e.originY,a-e.originX),p=((n*(180/Math.PI)+90)%360+360)%360;e.shape.transform(e.currentTransformation),e.shape.transform(Raphael.format("...R{0},{1},{2}",p-e.currentRotaion,e.originX,e.originY)),e.syncTracker()},function(){var r=e.shape.getBBox();t.getRelativePositionToWindow(e.editor.container);e.originX=(r.x+r.x2)/2,e.originY=(r.y+r.y2)/2,e.currentRotaion=e.shape.matrix.split().rotate,e.currentTransformation=e.shape.transform()},function(){}),this.trackerSet.hide()},e.prototype.resize=function(t,e){0>t||0>e||(this.shape.attr("width",t),this.shape.attr("height",e))},e.prototype.postCreate=function(){var t=this.shape.getBBox();0===t.width||0===t.height?this.shape.remove():(this.editor.shapes.push(this),this.addTracker())},e.prototype.remove=function(){this.shape.remove()},e.prototype.showTracker=function(){this.trackerSet.show(),this.trackerSet.toFront(),this.shape.toFront()},e.prototype.hideTracker=function(){this.trackerSet.hide()},e.prototype.syncTracker=function(){this.trackerSet.transform(this.shape.transform())},e.prototype.save=function(){return{type:this.shape.type,x:this.shape.attr("x"),y:this.shape.attr("y"),width:this.shape.attr("width"),height:this.shape.attr("height"),stroke:0===this.shape.attr("stroke")?"none":this.shape.attr("stroke"),"stroke-width":this.shape.attr("stroke-width"),fill:this.shape.attr("fill"),transform:this.shape.transform().toString()}},e}();t.BaseShape=e}(VectorEditor||(VectorEditor={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},VectorEditor;!function(t){var e=function(t){function e(e,r,i,a){t.call(this,e),this.shape=this.paper.rect(r,i,0,0),this.shape.attr(a),this.shape.id=Raphael.createUUID(),this.registerDragShapeEvent()}return __extends(e,t),e}(t.BaseShape);t.Rect=e}(VectorEditor||(VectorEditor={}));var VectorEditor;!function(t){var e=function(t){function e(e,r,i,a){t.call(this,e),this.shape=this.paper.ellipse(r,i,0,0),this.shape.attr(a),this.shape.id=Raphael.createUUID(),this.registerDragShapeEvent()}return __extends(e,t),e.prototype.resize=function(t,e){0>t||0>e||(this.shape.attr("rx",t),this.shape.attr("ry",e))},e.prototype.save=function(){var e=t.prototype.save.call(this);return $.extend(e,{rx:this.shape.attr("rx"),ry:this.shape.attr("ry"),cx:this.shape.attr("cx"),cy:this.shape.attr("cy")})},e}(t.BaseShape);t.Ellipse=e}(VectorEditor||(VectorEditor={}));var VectorEditor;!function(t){var e=function(t){function e(e,r,i,a){t.call(this,e),this.shape=this.paper.path(Raphael.format("M{0},{1}",r,i)),this.shape.attr(a),this.shape.id=Raphael.createUUID(),this.registerDragShapeEvent()}return __extends(e,t),e.prototype.resize=function(t,e){var r=Raphael.parsePathString(this.shape.attr("path"));r.splice(1),this.shape.attr("path",Raphael.format("{0}L{1},{2}",r.toString(),r[0][1]+t,r[0][2]+e))},e.prototype.save=function(){var e=t.prototype.save.call(this);return $.extend(e,{type:"line",path:this.shape.attr("path")})},e}(t.BaseShape);t.SimpleLine=e}(VectorEditor||(VectorEditor={}));var VectorEditor;!function(t){var e=function(t){function e(e,r,i,a){t.call(this,e),this.shape=this.paper.path(Raphael.format("M{0},{1}",r,i)),this.shape.attr(a),this.shape.id=Raphael.createUUID(),this.registerDragShapeEvent()}return __extends(e,t),e.prototype.resize=function(t,e){var r=Raphael.parsePathString(this.shape.attr("path"));this.shape.attr("path",Raphael.format("{0}L{1},{2}",r.toString(),r[0][1]+t,r[0][2]+e))},e.prototype.save=function(){var e=t.prototype.save.call(this);return $.extend(e,{type:"path",path:this.shape.attr("path")})},e}(t.BaseShape);t.SvgPath=e}(VectorEditor||(VectorEditor={}));var VectorEditor;!function(t){var e=function(t){function e(e,r,i,a){t.call(this,e),this.shape=this.paper.text(r,i,a.text),this.shape.attr(a),this.shape.id=Raphael.createUUID(),this.registerDragShapeEvent()}return __extends(e,t),e.prototype.resize=function(t,e){0>t||0>e||this.shape.attr("font-size",Math.sqrt(e*e+t*t))},e.prototype.save=function(){var e=t.prototype.save.call(this);return $.extend(e,{font:this.shape.attr("font"),"font-family":this.shape.attr("font-family"),"font-size":this.shape.attr("font-size"),text:this.shape.attr("text")})},e}(t.BaseShape);t.Text=e}(VectorEditor||(VectorEditor={}));var VectorEditor;!function(t){function e(e,r,i,a,o){return"rect"===a?new t.Rect(e,r,i,o):"ellipse"===a?new t.Ellipse(e,r,i,o):"line"===a?new t.SimpleLine(e,r,i,o):"path"===a?new t.SvgPath(e,r,i,o):"text"===a?new t.Text(e,r,i,o):void 0}t.createShape=e}(VectorEditor||(VectorEditor={}));var VectorEditor;!function(t){function e(t){var e=t.offset(),r=$(window).scrollTop(),i=$(window).scrollLeft();return[e.left-i,e.top-r]}t.getRelativePositionToWindow=e}(VectorEditor||(VectorEditor={}));var VectorEditor;!function(t){var e=function(){function e(t){this.container=$(t),this.paper=Raphael(t,$(t).width(),$(t).height()),this.prop={"stroke-width":2,stroke:"#000000",fill:"#000000","stroke-opacity":1,"fill-opacity":0,text:"text"},this.mode="select",this.shapes=[],this.onHitXy=[0,0],this.registerMouseEvents()}return e.prototype.set=function(t,e){this.prop[t]=e,this.currentShape&&this.currentShape.trackerSet&&this.currentShape.shape.attr(t,e)},e.prototype["delete"]=function(){this.currentShape&&this.currentShape.trackerSet&&(this.shapes.splice(this.shapes.indexOf(this.currentShape),1),this.currentShape.trackerSet.remove(),this.currentShape.remove())},e.prototype.clear=function(){this.paper.clear()},e.prototype.load=function(e,r,i){var a=this;void 0===r&&(r=0),void 0===i&&(i=0);var o=JSON.parse(e);o.forEach(function(e){var o=t.createShape(a,0,0,e.type,e);o.shape.transform(Raphael.format("...T{0},{1}",r,i)),o.postCreate()})},e.prototype.serialize=function(){var t=[];return this.shapes.forEach(function(e){t.push(e.save())}),JSON.stringify(t)},e.prototype.setMode=function(t){"select"!==t&&this.unSelectAll(),this.mode=t},e.prototype.unSelectAll=function(){this.shapes.forEach(function(t){t.hideTracker()}),this.currentShape=null},e.prototype.registerMouseEvents=function(){var t=this;this.container.bind("mousedown",function(e){t.onMouseDown(e)}),this.container.bind("mouseup",function(e){t.onMouseUp(e)}),this.container.bind("mousemove",function(e){t.onMouseMove(e)})},e.prototype.onMouseDown=function(e){e.preventDefault();var r=t.getRelativePositionToWindow(this.container),i=e.clientX-r[0],a=e.clientY-r[1];if("select"===this.mode){if("svg"===e.target.tagName)return void this.unSelectAll()}else if("delete"===this.mode);else{if(this.drawing)return;this.drawing=!0;var o=t.createShape(this,i,a,this.mode,this.prop);this.currentShape=o,this.onHitXy=[i,a]}},e.prototype.onMouseMove=function(e){if(this.drawing&&this.currentShape){var r=t.getRelativePositionToWindow(this.container),i=e.clientX-r[0],a=e.clientY-r[1],o=this.currentShape;o.resize(i-this.onHitXy[0],a-this.onHitXy[1])}},e.prototype.onMouseUp=function(t){this.drawing&&this.currentShape&&(this.currentShape.postCreate(),this.currentShape=null,this.drawing=!1)},e}();t.Editor=e}(VectorEditor||(VectorEditor={}));